name: CI

on:
  pull_request:
  push:
    branches:
      - main

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cryptoalert-pro-backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: cryptoalert-pro-backend/package-lock.json
      - run: npm ci
      - run: npm run lint

  typecheck:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cryptoalert-pro-backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: cryptoalert-pro-backend/package-lock.json
      - run: npm ci
      - run: npm run typecheck

  unit:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cryptoalert-pro-backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: cryptoalert-pro-backend/package-lock.json
      - run: npm ci
      - run: npm run reports:unit
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: junit-unit
          path: cryptoalert-pro-backend/reports/unit.junit.xml

  integration:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cryptoalert-pro-backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: cryptoalert-pro-backend/package-lock.json
      - run: npm ci
      - run: npm run reports:integration
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: junit-integration
          path: cryptoalert-pro-backend/reports/integration.junit.xml

  contract:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cryptoalert-pro-backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: cryptoalert-pro-backend/package-lock.json
      - run: npm ci
      - run: npm run reports:contract
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: junit-contract
          path: cryptoalert-pro-backend/reports/contract.junit.xml

  coverage-and-trend:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cryptoalert-pro-backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: cryptoalert-pro-backend/package-lock.json
      - run: npm ci
      - run: npm run coverage:ci
      - name: Restore trend history
        uses: actions/cache/restore@v4
        with:
          path: cryptoalert-pro-backend/reports/ci-trend/history.json
          key: ci-trend-${{ github.ref_name }}
          restore-keys: |
            ci-trend-
      - run: node scripts/ci/update-trend.mjs
      - name: Save trend history
        uses: actions/cache/save@v4
        if: always()
        with:
          path: cryptoalert-pro-backend/reports/ci-trend/history.json
          key: ci-trend-${{ github.ref_name }}-${{ github.run_id }}
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-and-trend
          path: |
            cryptoalert-pro-backend/reports/coverage
            cryptoalert-pro-backend/reports/ci-trend/history.json

  security-scan:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cryptoalert-pro-backend
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: cryptoalert-pro-backend/package-lock.json
      - run: npm ci
      - run: npm run security:scan

  required-checks:
    if: always()
    runs-on: ubuntu-latest
    needs:
      - lint
      - typecheck
      - unit
      - integration
      - contract
      - coverage-and-trend
      - security-scan
    steps:
      - name: Fail if any required check failed
        run: |
          if [[ "${{ needs.lint.result }}" != "success" || \
                "${{ needs.typecheck.result }}" != "success" || \
                "${{ needs.unit.result }}" != "success" || \
                "${{ needs.integration.result }}" != "success" || \
                "${{ needs.contract.result }}" != "success" || \
                "${{ needs.coverage-and-trend.result }}" != "success" || \
                "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "Required CI checks failed"
            exit 1
          fi
          echo "All required CI checks passed"
